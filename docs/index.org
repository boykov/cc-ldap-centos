#+TITLE: Аутентификация пользователей CentOS 5/6 с использованием OpenLDAP 2.3/2.4
#+OPTIONS: toc:4 H:6 num:nil html-postamble:nil ^:nil tags:nil author:nil
#+SETUPFILE: theme-readtheorg-local.setup
#+HTML_HEAD: <style type="text/css">.org-src-name{ text-align: right; }</style>
#+HTML_HEAD: <style type="text/css">.outline-2{ margin-top: 60px; }</style>
# #+HTML_HEAD: <style type="text/css">#content{ text-align: justify; }</style>
# #+HTML_HEAD: <style type="text/css">#content{ -moz-hyphens: auto;-webkit-hyphens: auto;-ms-hyphens: auto; }</style>

* Установка и настройка сервера OpenLDAP
:PROPERTIES:
:CUSTOM_ID: install-and-config
:ID:       f3a148ae-26f4-4c54-a25c-532d2b9086ba
:END:

#+begin_quote
Необходимо разработать документацию по установке и настройке сервера LDAP в ОС CentOS 5. Предпочтение отдавать реализациям, доступным в базовом репозитории дистрибутива. Проверить работоспособность выработанных инструкций в ОС CentOS 6.
#+end_quote

# Процедура [[convert][конвертации]]

#+begin_sidebar
Команды и конфигурационные файлы прошли проверку на работоспособность в тестовом программном окружении, доступном в проекте [[https://github.com/boykov/cc-ldap-centos][cc-ldap-centos]].
#+end_sidebar

** Установка OpenLDAP
:PROPERTIES:
:CUSTOM_ID: install-openldap
:ID:       cdb77a09-a1eb-4db8-ad05-e45c3b49418c
:END:

# #+INCLUDE: "../ldap-server/Dockerfile" src dockerfile :lines "6-7"

Базовые репозитории дистрибутивов CentOS 5 и CentOS 6 содержат 2.3 и 2.4 версию OpenLDAP, соответственно. Выполнив стандартную установку
# #+INCLUDE: "../ldap-server/Dockerfile" src dockerfile :lines "18-21"
# #+begin_tip
# Там, где это не вызывает недоразумений, иногда будет использоваться синтаксис Dockerfile. Например, предыдущая команда означает просто src_sh[:exports code]{yum -y install openldap-server openldap-clients}.
# #+end_tip
#+caption: Установка сервера OpenLDAP для 5/2.3 и 6/2.4
#+begin_src sh
yum -y install openldap openldap-servers openldap-clients sudo
#+end_src
получаем 2 конфигурации, различающиеся в некоторых деталях. Например, название сервиса: *ldap* в случае CentOS 5/2.3 OpenLDAP (5/2.3) и *slapd* в случае CentOS 6/2.4 OpenLDAP (6/2.4).

#+name: run-prefix
#+begin_src sh :exports none

set -e

if [ ! -f /data/lib/ldap/DB_CONFIG ]; then
    if [ -z "$LDAP_ROOT_PASSWORD" -o -z "$LDAP_MANAGER_PASSWORD" ]; then
	echo "Need LDAP_ROOT_PASSWORD and LDAP_MANAGER_PASSWORD"
	exit
    fi

#+end_src

** Настройка базы данных BDB
:PROPERTIES:
:CUSTOM_ID: configure-bdb
:ID:       af4bb15a-67f0-4e1a-8ce6-18c118ff10cd
:END:

Для запуска сервиса *ldap* (*slapd*) необходимо подготовить каталог и файл конфигурации базы данных. Расположение образца файла настройки, в 5/2.3
#+name: run-db-config5
#+begin_src sh :exports none
    cp /etc/openldap/DB_CONFIG.example /var/lib/ldap/DB_CONFIG
    chown ldap. /var/lib/ldap/DB_CONFIG

#+end_src
#+caption: Конфигурация БД для 5/2.3
#+begin_src sh :exports code :noweb yes
<<run-db-config5>>
#+end_src
а в 6/2.4
#+name: run-db-config6
#+begin_src sh :exports none
    cp /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG
    chown ldap. /var/lib/ldap/DB_CONFIG

#+end_src
#+caption: Конфигурация БД для 6/2.4
#+begin_src sh :exports code :noweb yes
<<run-db-config6>>
#+end_src
Используем настройки без изменений в обеих конфигурациях.
** Предварительная настройка схемы БД LDAP
:PROPERTIES:
:CUSTOM_ID: configure-slapd
:ID:       fd3e3e26-d416-4cc5-9dfa-554caeaf7830
:END:

Конфигурация 5/2.3 по умолчанию настраивается файлом *slapd.conf*. Такой подход считается устаревшим, [[http://www.openldap.org/doc/admin24/guide.html#Converting%20old%20style%20{{slapd.conf}}%285%29%20file%20to%20{{cn=config}}%20format][рекомендуется]] использовать *cn=config* формат. Конфигурация 6/2.4 поставляется с двумя эквивалентными вариантами, доступными через файл *slapd.conf.obsolete* и *slapd.d* каталог, содержащий настройки в *cn=config* формате.

Внесем небольшие изменения в конфигурационный файл для 5/2.3

#+begin_html
<div align="right">
<a onclick="toggleDiv2('myContent',$(this));" class="fa fa-caret-right">/root/slapd.conf</a>
</div>
#+end_html
#+HTML: <div id="myContent" style="display:none">
#+caption: Конфигурационный файл для 5/2.3
#+INCLUDE: /home/eab/git/cc/cc-ldap-centos/ldap-server/slapd.conf src conf-space :exports (when (eq org-export-current-backend 'odt) "none")
#+HTML: </div>
#+caption: Настройка *conf*-файла для 5/2.3
#+INCLUDE: ../gen/slapd.diff src diff
и произведем первый запуск сервиса
#+name: run-slapd-conf5
#+begin_src sh :exports none
    cp /usr/share/doc/sudo-1.7.2p1/schema.OpenLDAP /etc/openldap/schema/sudo.schema
    chown ldap. /etc/openldap/schema/sudo.schema

    mv /etc/openldap/slapd.conf /etc/openldap/slapd.conf.original
    cp /root/slapd.conf /etc/openldap/slapd.conf
    chown ldap. /etc/openldap/slapd.conf

    diff /etc/openldap/slapd.conf.original /etc/openldap/slapd.conf > /gen/slapd.diff || true

#+end_src
#+caption: Первый запуск сервиса для 5/2.3
#+begin_src sh :exports code :noweb yes
<<run-slapd-conf5>>
<<run-slapd-start5>>
#+end_src

#+name: run-slapd-start5
#+begin_src sh :exports none
    service ldap start
#+end_src

#+name: run-slapd-start6
#+begin_src sh :exports none
    service slapd start
#+end_src
Выполним аналогичные действия для 6/2.4

#+begin_html
<div align="right">
<a onclick="toggleDiv2('myContent2',$(this));" class="fa fa-caret-right">/root/slapd.conf.obsolete</a>
</div>
#+end_html
#+HTML: <div id="myContent2" style="display:none">
#+caption: Конфигурационный файл для 6/2.4
#+INCLUDE: /home/eab/git/cc/cc-ldap-centos/ldap-server/slapd.conf.obsolete src conf-space :exports (when (eq org-export-current-backend 'odt) "none")
#+HTML: </div>
#+caption: Настройка *conf*-файла для 6/2.4
#+INCLUDE: ../gen/slapd.obsolete.diff src diff

#+begin_attention
В случае с CentOS 6 и OpenLDAP 2.4 здесь дополнительно удаляется конфигурация *slapd.d*.
#+end_attention

#+name: run-slapd-conf6
#+begin_src sh :exports none
    cp /usr/share/doc/sudo-1.8.6p3/schema.OpenLDAP /etc/openldap/schema/sudo.schema
    chown ldap. /etc/openldap/schema/sudo.schema

    cp /root/slapd.conf.obsolete /etc/openldap/slapd.conf
    chown ldap. /etc/openldap/slapd.conf
    rm -rf /etc/openldap/slapd.d

    diff /usr/share/openldap-servers/slapd.conf.obsolete /etc/openldap/slapd.conf > /gen/slapd.obsolete.diff || true

#+end_src
#+caption: Первый запуск сервиса для 6/2.4
#+begin_src sh :exports code :noweb yes
<<run-slapd-conf6>>
<<run-slapd-start6>>
#+end_src

** Преобразование в *cn=config* формат
:PROPERTIES:
:CUSTOM_ID: config-transform
:ID:       3d434678-6d24-4888-a97a-ac0c493ff0ec
:END:

<<convert>>Теперь для обеих конфигураций можно осуществить переход к *cn=config* формату и избавиться от *slapd.conf*
#+name: run-slapd-d
#+begin_src sh :exports none
    sleep 3

    kill -INT `cat /var/run/openldap/slapd.pid`
    oldpath=`pwd`
    cd /etc/openldap
    mkdir slapd.d
    slaptest -f slapd.conf -F slapd.d
    chown -R ldap:ldap slapd.d
    chmod -R 0750 slapd.d
    mv slapd.conf slapd.conf.bak
    cd $oldpath
#+end_src
#+caption: Преобразование к *cn=config* формату для 5/2.3 и 6/2.4
#+begin_src sh :exports code :noweb yes
<<run-slapd-d>>
#+end_src
После перезапуска, для 5/2.3
#+begin_src sh :exports code :noweb yes
<<run-slapd-start5>>
#+end_src
и для 6/2.4
#+begin_src sh :exports code :noweb yes
<<run-slapd-start6>>
#+end_src
получаем сервисы, отличающиеся только настройками по умолчанию, поставляемыми из базовых репозиториев в файлах */etc/openldap/slapd.conf* (5/2.3) и */usr/share/openldap-servers/slapd.conf.obsolete* (6/2.4).

** Установка пароля менеджера схемы
:PROPERTIES:
:CUSTOM_ID: add-manager
:ID:       234e1535-dac2-4e77-8d65-8267aca6044d
:END:

Чтобы иметь доступ к серверу LDAP для конфигурирование схемы БД LDAP, внесем необходимые изменения: пропишем пароль менеджера схемы *cn=Manager,cn=config*. Для обеих конфигураций выполним следующие действия

#+name: run-modify
#+begin_src sh :exports none
    sleep 3

    ROOT_PWD=$(slappasswd -s $LDAP_ROOT_PASSWORD)
    # Use bash variable subsitution to escape special chars http://stackoverflow.com/a/14339705
    sed -i "s+%LDAP_ROOT_PASSWORD%+${ROOT_PWD//+/\\+}+" /root/manager.ldif
    ldapmodify -v -D cn=Manager,cn=config -f /root/manager.ldif -x -w 1

#+end_src
#+caption: Начальное конфигурирование схемы БД LDAP для 5/2.3 и 6/2.4
#+begin_src sh :exports code :noweb yes
<<run-modify>>
#+end_src

#+name: run-postfix
#+begin_src sh :exports none
    kill -INT `cat /var/run/openldap/slapd.pid`
    sleep 3

    mkdir /data/lib /data/etc
    cp -ar /var/lib/ldap /data/lib
    cp -ar /etc/openldap /data/etc
fi

rm -rf /var/lib/ldap && ln -s /data/lib/ldap /var/lib/ldap
rm -rf /etc/openldap && ln -s /data/etc/openldap /etc/openldap

exec /usr/sbin/slapd -h "ldap:/// ldaps:/// ldapi:///" -u ldap -d $DEBUG_LEVEL
#+end_src

#+caption: Файл *manager.ldif*
#+name: manager-ldif
#+INCLUDE: ../ldap-server/manager.ldif src ldif

#+begin_note
Первичный доступ к схемам LDAP, использущим только *cn=config* формат
(без *conf*-файлов), осуществляется при помощи *ldapi* интерфейса.  В
случае 5/2.3 при использовании *-Y EXTERNAL -H ldapi:///* флагов
появляется ошибка *Insufficient access (50)*.  Поэтому, используется
явное задание пароля для rootdn (*cn=Manager,cn=config*) в
*conf*-файле и последующее его изменение через *ldapmodify*, имитируя
использование *ldapi*.
#+end_note

Дальнейшая настройка схемы осуществляется в разделе [[#schema][Схема БД LDAP]].

#+begin_src sh :tangle ~/git/cc/cc-ldap-centos/ldap-server/run5.sh :comments noweb :shebang "#!/bin/bash" :exports none :noweb yes
<<run-prefix>>
<<run-db-config5>>
<<run-slapd-conf5>>
<<run-slapd-start5>>
<<run-slapd-d>>
<<run-slapd-start5>>
<<run-modify>>
<<run-postfix>>
#+end_src

#+begin_src sh :tangle ~/git/cc/cc-ldap-centos/ldap-server/run6.sh :comments noweb :shebang "#!/bin/bash" :exports none :noweb yes
<<run-prefix>>
<<run-db-config6>>
<<run-slapd-conf6>>
<<run-slapd-start6>>
<<run-slapd-d>>
<<run-slapd-start6>>
<<run-modify>>
<<run-postfix>>
#+end_src

* Настройка аутентификации пользователей при помощи LDAP
:PROPERTIES:
:CUSTOM_ID: authentification
:ID:       49b5e2df-0c06-445a-ae9e-66bcd6cc9e40
:END:

#+begin_quote
Необходимо разработать документацию по настройке аутентификации пользователей при помощи LDAP в ОС CentOS 5. Проверить работоспособность выработанных инструкций в ОС CentOS 6.

В документацию должно входить:

- Список пакетов, которые необходимо установить;
- Список файлов, модификация которых необходима для настройки процесса аутентификации посредством LDAP;
- Описание всех опций, выставляемых в этих файлах.
#+end_quote

** Требуемые пакеты
:PROPERTIES:
:CUSTOM_ID: client-packages
:ID:       a4da4894-117b-40b6-a6c7-1447f083d6e1
:END:

Для настройки клиентского подключения в 5/2.3 понадобятся следующие пакеты

#+caption: Установка клиента для 5/2.3
#+begin_src sh :exports code
yum install -y openssh-server openldap-clients nss_ldap authconfig
yum install -y openldap openldap-servers sudo
#+end_src

Здесь также необходим пакет *openldap-servers*, поскольку утилиты для миграции пользователей содержатся в нем. Для 6/2.4 выполним

#+caption: Установка клиента для 6/2.4
#+begin_src sh :exports code
yum install -y openssh-server openldap-clients nss-pam-ldapd authconfig
yum install -y openldap migrationtools sudo
#+end_src

#+name: client5-run-prefix
#+begin_src sh :exports none

cp -R /etc /gen/etc5/etc

opts="-N -x group -x shadow -x gshadow -x system-auth-ac -x passwd"

#+end_src

#+name: client6-run-prefix
#+begin_src sh :exports none

cp -R /etc /gen/etc6/etc

opts="-N -x fingerprint-auth-ac -x password-auth-ac \
-x smartcard-auth-ac -x system-auth-ac -x S12nslcd -x K88nslcd"

#+end_src

#+name: client5-run-setup
#+begin_src sh :exports none
authconfig --enableshadow --enablemkhomedir --enableldap --enableldapauth \
	   --ldapserver=$LDAP_SERVER --ldapbasedn=$LDAP_BASEDN --update
#+end_src

#+name: client6-run-setup
#+begin_src sh :exports none
authconfig --enablemkhomedir --enableldap --enableldapauth \
	   --ldapserver=$LDAP_SERVER --ldapbasedn=$LDAP_BASEDN --update
#+end_src

#+name: client5-run-sudoers
#+begin_src sh :exports none

echo sudoers_base dc=mercury,dc=febras,dc=net >> /etc/ldap.conf
echo sudoers_debug 0 >> /etc/ldap.conf

#+end_src

#+name: client6-run-sudoers
#+begin_src sh :exports none

echo sudoers:  files ldap >> /etc/nsswitch.conf

echo uri ldap://$LDAP_SERVER/ >> /etc/sudo-ldap.conf
echo base dc=mercury,dc=febras,dc=net >> /etc/sudo-ldap.conf
echo sudoers_base dc=mercury,dc=febras,dc=net >> /etc/sudo-ldap.conf
echo sudoers_debug 0 >> /etc/sudo-ldap.conf

#+end_src

#+name: client5-run-postfix
#+begin_src sh :exports none

cp -R /etc /gen/etc5/etcnew

diff -r $opts /gen/etc5/etc /gen/etc5/etcnew > /gen/client5.diff || true
sed -i 's|.*etcnew|/etc|g' /gen/client5.diff
diff -q -r /gen/etc5/etc /gen/etc5/etcnew | awk -F"etcnew" '{print "/etc"$2}' | sed 's/ differ//g' | sed 's|: |/|g' > /gen/client5-files.diff || true

rm -rf /gen/etc5/etc
rm -rf /gen/etc5/etcnew

getent passwd username

/usr/share/openldap/migration/migrate_passwd.pl /etc/passwd > /gen/passwd.ldif

/usr/share/openldap/migration/migrate_group.pl /etc/group > /gen/group.ldif

/usr/sbin/sshd -D
#+end_src

#+name: client6-run-postfix
#+begin_src sh :exports none

cp -R /etc /gen/etc6/etcnew

diff -r $opts /gen/etc6/etc /gen/etc6/etcnew > /gen/client6.diff || true
sed -i 's|.*etcnew|/etc|g' /gen/client6.diff
diff -q -r /gen/etc6/etc /gen/etc6/etcnew | grep -v "K88nslcd" | grep -v "S12nslcd" | awk -F"etcnew" '{print "/etc"$2}' | sed 's/ differ//g' | sed 's|: |/|g' > /gen/client6-files.diff || true

rm -rf /gen/etc6/etc
rm -rf /gen/etc6/etcnew

getent passwd username

# do not need migrate centos 6 users
# /usr/share/migrationtools/migrate_passwd.pl /etc/passwd > /gen/passwd6.ldif
# /usr/share/migrationtools/migrate_group.pl /etc/group > /gen/group6.ldif
/usr/sbin/sshd -D
#+end_src


#+begin_src sh :tangle ~/git/cc/cc-ldap-centos/ldap-client/run5.sh :comments noweb :shebang "#!/bin/bash" :exports none :noweb yes
<<client5-run-prefix>>
<<client5-run-setup>>
<<client5-run-sudoers>>
<<client5-run-postfix>>
#+end_src

#+begin_src sh :tangle ~/git/cc/cc-ldap-centos/ldap-client/run6.sh :comments noweb :shebang "#!/bin/bash" :exports none :noweb yes
<<client6-run-prefix>>
<<client6-run-setup>>
<<client6-run-sudoers>>
<<client6-run-postfix>>
#+end_src

** Используемые команды
:PROPERTIES:
:CUSTOM_ID: client-commands
:ID:       6e7a8278-7334-46f7-b289-07da7f2b6d14
:END:

Модифицируем с помощью *authconfig* и *echo*-команд конфигурацию клиента, отдельно настроим */etc/ldap.conf*. Для 5/2.3

#+caption: Настройка клиента для 5/2.3
#+begin_src sh :exports code :noweb yes
<<client5-run-setup>>
<<client5-run-sudoers>>
#+end_src
и для 6/2.4 (здесь дополнительно модифицируются файлы *nsswitch.conf* и *sudo-ldap.conf*)
#+caption: Настройка клиента для 6/2.4
#+begin_src sh :exports code :noweb yes
<<client6-run-setup>>
<<client6-run-sudoers>>
#+end_src

** Изменяемые файлы
:PROPERTIES:
:CUSTOM_ID: client-files
:ID:       386e40de-d1f2-4dc8-994b-5870d4ec42fb
:END:

Файлы, которые были модифицированы [[#client-commands][настройками]] в случае 5/2.3

#+begin_html
<div align="right">
<a onclick="toggleDiv2('myContent-client5-files',$(this));" class="fa fa-caret-down">client5-files.diff</a>
</div>
#+end_html
#+HTML: <div id="myContent-client5-files" style="display:true">
#+caption: Список измененных файлов для 5/2.3
#+INCLUDE: /home/eab/git/cc/cc-ldap-centos/gen/client5-files.diff src diff
#+HTML: </div>

и в случае 6/2.4

#+begin_html
<div align="right">
<a onclick="toggleDiv2('myContent-client6-files',$(this));" class="fa fa-caret-down">client6-files.diff</a>
</div>
#+end_html
#+HTML: <div id="myContent-client6-files" style="display:true">
#+caption: Список измененных файлов для 6/2.4
#+INCLUDE: /home/eab/git/cc/cc-ldap-centos/gen/client6-files.diff src diff
#+HTML: </div>

** Описание опций
:PROPERTIES:
:CUSTOM_ID: client-options
:ID:       a8dfad56-906c-45b6-9ef1-7d5a9cfa854f
:END:

#+begin_html
<a onclick="toggleDiv2('myContent-client5',$(this));" class="fa fa-caret-right">client5.diff</a>
#+end_html

#+HTML: <div id="myContent-client5" style="display:none">
#+INCLUDE: /home/eab/git/cc/cc-ldap-centos/gen/client5.diff src diff :exports (when (eq org-export-current-backend 'odt) "none")
#+HTML: </div>

#+begin_html
<br/><a onclick="toggleDiv2('myContent-client6',$(this));" class="fa fa-caret-right">client6.diff</a>
#+end_html

#+HTML: <div id="myContent-client6" style="display:none">
#+INCLUDE: /home/eab/git/cc/cc-ldap-centos/gen/client6.diff src diff :exports (when (eq org-export-current-backend 'odt) "none")
#+HTML: </div>

* Схема БД LDAP
:PROPERTIES:
:CUSTOM_ID: schema
:ID:       b64d7c36-b2b3-49ac-9620-d7c94eb9ea31
:END:

#+begin_quote
Необходимо разработать схему БД LDAP, предназначенную для хранения учетных данных пользователей кластера.
#+end_quote

** Подготовка к тестированию аутентификации при помощи LDAP
:PROPERTIES:
:CUSTOM_ID: minimal-schema
:ID:       3446a07c-3649-4e85-84c1-044e78c340dc
:END:

Чтобы получить минимально работоспособный сервер LDAP, позволяющий
осуществлять аутентификацию для клиентских систем, внесем необходимые
изменения в схему. В частности, [[domain-ldif][сконфигурируем]] базу *bdb* для
доменного имени *dc=mercury,dc=febras,dc=net*, определим менеджера
домена *cn=Manager,dc=mercury,dc=febras,dc=net* и его пароль.  Также,
добавим в *domain.ldif* правила доступа к атрибутам *userPassword* и
*shadowLastChange*: для менеджера домена и владельца записи -- write и
для неавторизованного пользователя -- auth.

Далее, [[base-ldif][пропишем]] необходимые атрибуты, начиная с корневого узла *dn:
dc=mercury,dc=febras,dc=net*, добавим подразделения *people*, *groups*
и *sudoers*. Создадим одну posix-группу *wheel* и сконфигурируем
*sudoers* так, чтобы разрешить выполнение *sudo* команд без ввода
пароля для членов этой группы.

#+name: build-schema
#+begin_src sh :exports none

cd /schema

ldapmodify -v -D cn=Manager,cn=config -f domain.ldif -x -w $LDAP_ROOT_PASSWORD
ldapadd -x -D 'cn=Manager,dc=mercury,dc=febras,dc=net' -w $LDAP_MANAGER_PASSWORD -f base.ldif
#+end_src
#+begin_src sh :exports code :noweb yes
<<build-schema>>
#+end_src

#+begin_src sh :tangle ~/git/cc/cc-ldap-centos/schema/build.sh :comments noweb :shebang "#!/bin/bash" :exports none :noweb yes
<<build-schema>>
<<add-user>>
#+end_src

#+caption: Файл *domain.ldif*
#+name: domain-ldif
#+INCLUDE: ../schema/domain.ldif src ldif

# #+begin_html
# <br/><a onclick="toggleDiv2('myContent-domain',$(this));" class="fa fa-caret-right">/root/domain.ldif</a>
# #+end_html
# #+HTML: <div id="myContent-domain" style="display:none">
# #+INCLUDE: /home/eab/git/cc/cc-ldap-centos/schema/domain.ldif src ldif :exports (when (eq org-export-current-backend 'odt) "none")
# #+HTML: </div>
#+begin_html
<br/><a onclick="toggleDiv2('myContent-base',$(this));" class="fa fa-caret-right">/root/base.ldif</a>
#+end_html
#+HTML: <div id="myContent-base" style="display:none">
#+name: base-ldif
#+INCLUDE: /home/eab/git/cc/cc-ldap-centos/schema/base.ldif src ldif :exports (when (eq org-export-current-backend 'odt) "none")
#+HTML: </div>
# #+begin_html
# <br/><a onclick="toggleDiv2('myContent-admin',$(this));" class="fa fa-caret-down">/root/admin.ldif</a>
# #+end_html
# #+HTML: <div id="myContent-admin" style="display:true">
# #+INCLUDE: /home/eab/git/cc/cc-ldap-centos/ldap-server/admin.ldif src ldif
# #+HTML: </div>

* Процесс добавления нового пользователя в систему
:PROPERTIES:
:CUSTOM_ID: new-user
:ID:       6fe3c37d-639a-4656-9675-bdc7a6c5ddb2
:END:

#+begin_quote
Необходимо разработать документацию по процессу добавления нового
пользователя в систему, использующего аутентификацию посредством
LDAP. Предложить CLI (или GUI WEB) интерфейс для выполнения данной
операции. Ориентироваться на использование в ОС CentOS 5/6.
#+end_quote

** Добавление пользователя с помощью CLI интерфейса
:PROPERTIES:
:CUSTOM_ID: new-user-ldap
:ID:       6e8437bc-7e1f-489a-9afb-44f3d67d49ab
:END:

Используем утилиту *ldapadd* для добавления записи пользователя в формате *ldif*

#+name: add-user
#+begin_src sh :exports none
ldapadd -x -D 'cn=Manager,dc=mercury,dc=febras,dc=net' -w $LDAP_MANAGER_PASSWORD -f user.ldif

#+end_src
#+begin_src sh :exports code :noweb yes
<<add-user>>
#+end_src

#+caption: Файл *user.ldif*, применяемый для создания нового пользователя
#+INCLUDE: "../schema/user.ldif" src ldif
# #+begin_html
# <br/><a onclick="toggleDiv2('myContent-user',$(this));" class="fa fa-caret-right">/root/user.ldif</a>
# #+end_html
# #+HTML: <div id="myContent-user" style="display:none">
# #+INCLUDE: /home/eab/git/cc/cc-ldap-centos/schema/user.ldif src ldif :exports (when (eq org-export-current-backend 'odt) "none")
# #+HTML: </div>

** Добавление пользователя с помощью GUI Web интерфейса
:PROPERTIES:
:CUSTOM_ID: new-user-php
:ID:       6de9e6dc-04f2-429d-b22e-55caa2e270ee
:END:

#+NAME:   fig:php01
#+caption: Создание пользователя с использованием шаблона phpLDAPadmin
[[./php01.png]]

** Тестирование клиентского подключения
:PROPERTIES:
:CUSTOM_ID: test-client
:ID:       061371a3-a5d6-4fa2-9e15-2d8adef5caf0
:END:

Для проверки возможности аутентификации будем использовать [[#new-user-ldap][запись]] *username*. Протестируем подключение с помощью команды
#+begin_src sh
getent passwd username
#+end_src
которая выводит passwd данные пользователя *username* из доступных источников, в данном случае задействован сервер LDAP
#+begin_src conf-colon
username:x:1050:1030:User Name:/home/webminder:/bin/bash
#+end_src

Убедимся, что механизм *sudoers* задействован. Вывод команды
#+begin_src sh
sshpass -p p@ssw0rd ssh -t username@$(ip) sudo ls /root
#+end_src
демонстрирует, что пользователь *username* успешно прочитал содержимое каталога *root* с помощью *sudo*
#+begin_src raw
Dockerfile5  Dockerfile6  run5.sh  run6.sh
#+end_src

** Миграция пользователей и групп
:PROPERTIES:
:CUSTOM_ID: add-users
:ID:       3c998117-af2e-4965-94c7-3ebfb31d7691
:END:

#+begin_html
<a onclick="toggleDiv2('myContent-passwd',$(this));" class="fa fa-caret-right">passwd.ldif</a>
#+end_html

#+HTML: <div id="myContent-passwd" style="display:none">
#+INCLUDE: /home/eab/git/cc/cc-ldap-centos/gen/passwd.ldif src ldif :exports (when (eq org-export-current-backend 'odt) "none")
#+HTML: </div>

# do not need migrate centos 6 users
# #+begin_html
# <br/><a onclick="toggleDiv2('myContent-passwd6',$(this));" class="fa fa-caret-right">passwd6.ldif</a>
# #+end_html

# #+HTML: <div id="myContent-passwd6" style="display:none">
# #+INCLUDE: /home/eab/git/cc/cc-ldap-centos/gen/passwd6.ldif src ldif :exports (when (eq org-export-current-backend 'odt) "none")
# #+HTML: </div>

#+begin_html
<br/><a onclick="toggleDiv2('myContent-group',$(this));" class="fa fa-caret-right">group.ldif</a>
#+end_html

#+HTML: <div id="myContent-group" style="display:none">
#+INCLUDE: /home/eab/git/cc/cc-ldap-centos/gen/group.ldif src ldif :exports (when (eq org-export-current-backend 'odt) "none")
#+HTML: </div>

# do not need migrate centos 6 users
# #+begin_html
# <br/><a onclick="toggleDiv2('myContent-group6',$(this));" class="fa fa-caret-right">group6.ldif</a>
# #+end_html

# #+HTML: <div id="myContent-group6" style="display:none">
# #+INCLUDE: /home/eab/git/cc/cc-ldap-centos/gen/group6.ldif src ldif :exports (when (eq org-export-current-backend 'odt) "none")
# #+HTML: </div>

* Перевести аутентификацию пользователей кластера на использование LDAP
:PROPERTIES:
:CUSTOM_ID: cluster
:ID:       db5bc4cf-74c3-40e0-b8b3-d57f3f32e338
:END:

