#+TITLE: Аутентификация пользователей CentOS 5/6 с использованием OpenLDAP 2.3/2.4
#+OPTIONS: toc:4 H:6 num:t html-postamble:nil ^:nil tags:nil author:nil
#+SETUPFILE: theme-readtheorg-local.setup
#+HTML_HEAD: <style type="text/css">.org-src-name{ text-align: right; }</style>
#+HTML_HEAD: <style type="text/css">.outline-2{ margin-top: 60px; }</style>
#+MACRO: fa @@html:&nbsp;<sup><i class="fa fa-$1"></i></sup>@@
# #+BIBLIOGRAPHY: /home/eab/git/lit/ldap.bib plain option:-d
# #+HTML_HEAD: <style type="text/css">#content{ text-align: justify; }</style>
# #+HTML_HEAD: <style type="text/css">#content{ -moz-hyphens: auto;-webkit-hyphens: auto;-ms-hyphens: auto; }</style>

* Введение{{{fa(star-half-o)}}}
:PROPERTIES:
:CUSTOM_ID: intro
:UNNUMBERED: t
:ID:       be7bb1b4-d8e8-4b5f-8aa3-754d148fa6ba
:END:

В процессе написания использовались материалы

| English version                                                                                                       | Русская версия                          |
|-----------------------------------------------------------------------------------------------------------------------+-----------------------------------------|
| [[http://www.openldap.org/doc/admin24/][OpenLDAP Software 2.4 Administrator's Guide]]                                                                           | [[http://pro-ldap.ru/tr/admin24/index.html][Руководство администратора OpenLDAP 2.4]] |
| [[http://www.openldap.org/doc/admin23/][OpenLDAP Software 2.3 Administrator's Guide]]                                                                           |                                         |
| [[http://www.zytrax.com/books/ldap/][LDAP for Rocket Scientists]]                                                                                            | [[http://pro-ldap.ru/tr/zytrax/][LDAP для учёных-ракетчиков]]              |
| [[http://itdavid.blogspot.ru/2012/05/howto-centos-6.html][HOWTO : CentOS 6.2 OpenLDAP 2.4 Setup ]]                                                                                | [[http://pro-ldap.ru/books/openldap-ubuntu-in-practice/][OpenLDAP и Ubuntu на практике]]           |
| [[https://www.packtpub.com/networking-and-servers/mastering-openldap-configuring-securing-and-integrating-directory-services][Matt Butcher. *Mastering OpenLDAP: Configuring, Securing and Integrating Directory Services*. Packt Publishing, 2007.]] |                                         |
| [[http://www.linux-pam.org/Linux-PAM-html/Linux-PAM_SAG.html][The Linux-PAM System Administrators' Guide]]                                                                            |                                         |
# | [[cite:butcher2007mastering]]                   |                                         |

Конфигурация используемых на нашем демо-стенде контейнеров:

| Роль               | Имя контейнера | ОС         | Способ конфигурации *OpenLDAP* |
|--------------------+----------------+------------+--------------------------------|
| *Сервер каталогов* | server-ldif5   | *Centos 5* | *OpenLDAP 2.3* server, *ldif*  |
| *Сервер каталогов* | server-ldif6   | *Centos 6* | *OpenLDAP 2.4* server, *ldif*  |
| *Сервер каталогов* | server-conf5   | *Centos 5* | *OpenLDAP 2.3* server, *conf*  |
| *Сервер каталогов* | server-conf6   | *Centos 6* | *OpenLDAP 2.4* server, *conf*  |
| *Клиентский хост*  | client5        | *Centos 5* | *OpenLDAP 2.3* client          |
| *Клиентский хост*  | client6        | *Centos 6* | *OpenLDAP 2.4* client          |

#+begin_note
Команды и конфигурационные файлы прошли проверку на работоспособность в тестовом программном окружении, доступном в проекте [[https://github.com/boykov/cc-ldap-centos][cc-ldap-centos]].
#+end_note

* Установка и настройка сервера OpenLDAP
:PROPERTIES:
:CUSTOM_ID: install-and-config
:ID:       f3a148ae-26f4-4c54-a25c-532d2b9086ba
:END:

#+begin_quote
Необходимо разработать документацию по установке и настройке сервера LDAP в ОС *CentOS 5*. Предпочтение отдавать реализациям, доступным в базовом репозитории дистрибутива. Проверить работоспособность выработанных инструкций в ОС *CentOS 6*.
#+end_quote

# Процедура [[convert][конвертации]]

** Установка OpenLDAP
:PROPERTIES:
:CUSTOM_ID: install-openldap
:ID:       cdb77a09-a1eb-4db8-ad05-e45c3b49418c
:END:

# #+INCLUDE: "../ldap-server/Dockerfile" src dockerfile :lines "6-7"

Базовые репозитории дистрибутивов *CentOS 5* и *CentOS 6* содержат *2.3* и *2.4* версию *OpenLDAP*, соответственно. Выполнив стандартную установку
# #+INCLUDE: "../ldap-server/Dockerfile" src dockerfile :lines "18-21"
# #+begin_tip
# Там, где это не вызывает недоразумений, иногда будет использоваться синтаксис Dockerfile. Например, предыдущая команда означает просто src_sh[:exports code]{yum -y install openldap-server openldap-clients}.
# #+end_tip
#+caption: Установка сервера *OpenLDAP* для *5/2.3* и *6/2.4*
#+begin_src sh
yum -y install openldap openldap-servers openldap-clients sudo
#+end_src
получаем две конфигурации, различающиеся в некоторых деталях. Например, название сервиса: *ldap* в случае *CentOS 5/2.3 OpenLDAP* (*5/2.3*) и *slapd* в случае *CentOS 6/2.4 OpenLDAP* (*6/2.4*).

#+name: run-prefix
#+begin_src sh :exports none

set -e

if [ ! -f /data/lib/ldap/DB_CONFIG ]; then
    if [ -z "$LDAP_ROOT_PASSWORD" -o -z "$LDAP_MANAGER_PASSWORD" ]; then
	echo "Need LDAP_ROOT_PASSWORD and LDAP_MANAGER_PASSWORD"
	exit
    fi

#+end_src

** Добавление файлов конфигурации базы данных HDB
:PROPERTIES:
:CUSTOM_ID: configure-hdb
:ID:       af4bb15a-67f0-4e1a-8ce6-18c118ff10cd
:END:

Для запуска сервиса *ldap* (*slapd*) необходимо подготовить каталог и файл конфигурации базы данных. Расположение образца файла настройки, в *5/2.3*
#+name: run-db-config5
#+begin_src sh :exports none
    cp /etc/openldap/DB_CONFIG.example /var/lib/ldap/DB_CONFIG
    chown ldap. /var/lib/ldap/DB_CONFIG

#+end_src
#+caption: Конфигурация БД для *5/2.3*
#+begin_src sh :exports code :noweb yes
<<run-db-config5>>
#+end_src
а в *6/2.4*
#+name: run-db-config6
#+begin_src sh :exports none
    cp /usr/share/openldap-servers/DB_CONFIG.example /var/lib/ldap/DB_CONFIG
    chown ldap. /var/lib/ldap/DB_CONFIG

#+end_src
#+caption: Конфигурация БД для *6/2.4*
#+begin_src sh :exports code :noweb yes
<<run-db-config6>>
#+end_src
Используем настройки без изменений в обеих конфигурациях.
** Добавление файлов схем
:PROPERTIES:
:CUSTOM_ID: add-schemas
:ID:       6638ce89-fc58-4610-aa0a-ab3ade7d3825
:END:
Общая схема БД LDAP, в том числе, содержит раздел *cn=schema*, куда
подключаются дополнительные специфические схемы.  Подготовим
необходимые файлы (не включенные в поставку *OpenLDAP*), для *5/2.3*
#+name: schema-prepare5
#+begin_src sh :exports none
    cp /usr/share/doc/sudo-1.7.2p1/schema.OpenLDAP /etc/openldap/schema/sudo.schema
    chown ldap. /etc/openldap/schema/sudo.schema

#+end_src
#+name: schema-prepare6
#+begin_src sh :exports none
    cp /usr/share/doc/sudo-1.8.6p3/schema.OpenLDAP /etc/openldap/schema/sudo.schema
    chown ldap. /etc/openldap/schema/sudo.schema

#+end_src
#+caption: Добавление файлов схем для *5/2.3*
#+begin_src sh :exports code :noweb yes
<<schema-prepare5>>
#+end_src
и для *6/2.4*
#+caption: Добавление файлов схем для *6/2.4*
#+begin_src sh :exports code :noweb yes
<<schema-prepare6>>
#+end_src

** Выбор варианта настройки схемы БД LDAP
:PROPERTIES:
:CUSTOM_ID: choose-setup
:ID:       cb0ed9d0-14cc-4969-897d-a398e2f1ea65
:END:

Конфигурация *6/2.4* поставляется с тремя вариантами базовых настроек,
осуществляемых через файлы *slapd.conf.obsolete*, *slapd.ldif.example*
и, доступным по умолчанию, предварительно сформированным каталогом
*slapd.d*. При этом, настройка с помощью *slapd.ldif.example*
подразумевает использование утилиты *slapadd*, как это рекомендуется в
разделе руководства "быстрый
старт"[fn::http://pro-ldap.ru/tr/admin24/quickstart.html]. Конфигурация
*5/2.3* по умолчанию настраивается только файлом *slapd.conf*,
предварительно сформированный каталог *slapd.d* в формате *ldif*
отсутствует. Такой подход считается устаревшим,
рекомендуется[fn::http://pro-ldap.ru/tr/admin24/slapdconf2.html#Converting%20old%20style%20slapd.conf%20file%20to%20cn=config%20format]
использовать *ldif* формат и преобразовывать *slapd.conf* файл
настройки в каталог *slapd.d* с помощью утилиты *slaptest*.

Все варианты настроек разделяются на два существенно отличающихся
способа. Первый включает в себя настройку через *conf* файлы (
конвертация через *slaptest*) и предварительно сформированный каталог
*slapd.d* (только для версии *2.4*). Эти варианты являются
взаимозаменяемыми и формируют практически идентичные результирующие
файлы каталога *slapd.d*. Второй способ заключается в использовании
файла *slapd.ldif* и утилиты *slapdd*. В этом случае, содержимое
файлов каталога *slapd.d* существенно отличается, по сравнению с
первым способом. Дело в том, что при использовании первого способа в
файлах каталога *slapd.d* присутствует большое количество
дополнительных параметров (явно не указанных в файле *slapd.conf*), а
при использовании второго - только те, которые явно прописываются в
файле *slapd.ldif*. Хотя, здесь обнаружилось и небольшое исключение для записи *frontend*.

#+caption: Поддержка способов настройки схемы БД LDAP различными версиями *OpenLDAP*
| № | Способы настройки                               | поддержка *ldif*       | *2.3* | *2.4* |
|---+-------------------------------------------------+------------------------+-------+-------|
| 1 | Настройка с помощью файла *slapd.conf*          | конвертация *slaptest* | да    | да    |
| 2 | Настройка с помощью файла *slapd.ldif*          | да                     | особо | особо |
| 3 | Предварительно сформированный каталог *slapd.d* | да                     | нет   | да    |

Какой вариант настройки выбрать? Если требуется наличие тех
дополнительных параметров, которые разработчики посчитали нужным
включить в настройки по умолчанию, то выбирается первый способ
настройки - основной. При этом, если выбирается *2.3* версия
*OpenLDAP*, то используются *slapd.conf* файл и утилита *slaptest*. А
если *2.4* версия, то можно в качестве равноценной альтернативы воспользоваться
преварительно сформированным каталогом *slapd.d*.

Если же потребуется тщательно настраивать конфигурацию с нуля,
полностью контролируя все параметры, которые будут задействованы, то
нужно воспользоваться вторым способом - дополнительным.

** Предварительная настройка схемы БД LDAP
:PROPERTIES:
:CUSTOM_ID: configure-slapd-conf
:ID:       fd3e3e26-d416-4cc5-9dfa-554caeaf7830
:END:

Продемонстрируем первый способ настройки. Внесем небольшие изменения в
конфигурационный файл для *5/2.3*

#+begin_html
<div align="right">
<a onclick="toggleDiv2('myContent',$(this));" class="fa fa-caret-right">/root/slapd.conf</a>
</div>
#+end_html
#+HTML: <div id="myContent" style="display:none">
#+caption: Конфигурационный файл для *5/2.3*
#+INCLUDE: /home/eab/git/cc/cc-ldap-centos/schema/slapd.conf src conf-space :exports (when (eq org-export-current-backend 'odt) "none")
#+HTML: </div>
#+caption: Настройка *conf*-файла для *5/2.3*
#+INCLUDE: ../gen/slapd.diff src diff
и произведем первый запуск сервиса
#+caption: Первый запуск сервиса для *5/2.3*
#+begin_src sh :exports code :noweb yes
<<run-slapd-conf5>>
<<run-slapd-start5>>
#+end_src
Выполним аналогичные действия для *6/2.4*

#+begin_html
<div align="right">
<a onclick="toggleDiv2('myContent2',$(this));" class="fa fa-caret-right">/root/slapd.conf.obsolete</a>
</div>
#+end_html
#+HTML: <div id="myContent2" style="display:none">
#+caption: Конфигурационный файл для *6/2.4*
#+INCLUDE: /home/eab/git/cc/cc-ldap-centos/schema/slapd.conf.obsolete src conf-space :exports (when (eq org-export-current-backend 'odt) "none")
#+HTML: </div>
#+caption: Настройка *conf*-файла для *6/2.4*
#+INCLUDE: ../gen/slapd.obsolete.diff src diff

#+caption: Первый запуск сервиса для *6/2.4*
#+begin_src sh :exports code :noweb yes
<<run-slapd-conf6>>
<<run-slapd-start6>>
#+end_src

<<convert>>Теперь для обеих конфигураций можно осуществить переход к *cn=config* формату и избавиться от *slapd.conf*
#+caption: Преобразование к *cn=config* формату для *5/2.3* и *6/2.4*
#+begin_src sh :exports code :noweb yes
<<run-slapd-d>>
#+end_src
После перезапуска, для *5/2.3*
#+begin_src sh :exports code :noweb yes
<<run-slapd-start5>>
#+end_src
и для *6/2.4*
#+begin_src sh :exports code :noweb yes
<<run-slapd-start6>>
#+end_src
получаем сервисы, отличающиеся только настройками по умолчанию,
поставляемыми из базовых репозиториев в файлах
*/etc/openldap/slapd.conf* (*5/2.3*) и
*/usr/share/openldap-servers/slapd.conf.obsolete* (*6/2.4*).

Дальнейшая настройка схемы осуществляется в разделе [[#schema][Схема БД LDAP]].
** Дополнительно. Предварительная настройка схемы БД LDAP с помощью ldif формата
:PROPERTIES:
:CUSTOM_ID: configure-slapd
:ID:       fd3e3e26-d416-4cc5-9dfa-554caeaf7830
:END:

Продемонстрируем второй способ настройки для обеих конфигураций.

#+name: run-slapd-conf5
#+begin_src sh :exports none
    mv /etc/openldap/slapd.conf /etc/openldap/slapd.conf.original
    cp /root/slapd.conf /etc/openldap/slapd.conf
    ROOT_PWD=$(slappasswd -s $LDAP_ROOT_PASSWORD)
    # Use bash variable substitution to escape special chars http://stackoverflow.com/a/14339705
    sed -i "s+%LDAP_ROOT_PASSWORD%+${ROOT_PWD//+/\\+}+" /etc/openldap/slapd.conf
    chown ldap. /etc/openldap/slapd.conf

    diff /etc/openldap/slapd.conf.original /etc/openldap/slapd.conf > /gen/slapd.diff || true
#+end_src

#+name: run-slapd-start5
#+begin_src sh :exports none
    service ldap start
#+end_src

#+name: schema2ldif
#+begin_src sh :exports none
    rm -rf /etc/openldap/slapd.d
    rm -f /etc/openldap/slapd.conf
    mkdir -p /etc/openldap/slapd.d

    oldpath=`pwd`
    cd /etc/openldap/schema
    SCHEMAD=`pwd` SCHEMAS='core.schema cosine.schema inetorgperson.schema nis.schema sudo.schema' /root/2.5-schema-ldif.sh
    cp -R /etc/openldap/schema /gen/schema
    cd $oldpath

    ROOT_PWD=$(slappasswd -s $LDAP_ROOT_PASSWORD)
    # Use bash variable substitution to escape special chars http://stackoverflow.com/a/14339705
    sed -i "s+%LDAP_ROOT_PASSWORD%+${ROOT_PWD//+/\\+}+" /root/slapd.ldif
    slapadd -b cn=config -F /etc/openldap/slapd.d -l /root/slapd.ldif || true
    chown -R ldap. /etc/openldap/slapd.d/

#+end_src

#+name: run-slapd-d
#+begin_src sh :exports none
    sleep 3

    kill -INT `cat /var/run/openldap/slapd.pid`
    rm -rf /etc/openldap/slapd.d
    oldpath=`pwd`
    cd /etc/openldap
    mkdir slapd.d
    slaptest -f slapd.conf -F slapd.d
    chown -R ldap:ldap slapd.d
    chmod -R 0750 slapd.d
    mv slapd.conf slapd.conf.bak
    cd $oldpath
#+end_src

Конфигурация *5/2.3* поставляется со схемами только в *schema*
формате, а *6/2.4* - как в *schema*, так и в *ldif* формате. Файл
*sudo.schema* доступен только в *schema* формате. С помощью скрипта
*2.5-schema-ldif.sh*[fn::https://github.com/boykov/cc-ldap-centos/blob/master/ldap-server/2.5-schema-ldif.sh]
преобразуем необходимые схемы. Чтобы иметь доступ к серверу LDAP для
конфигурирования схемы БД LDAP, пропишем пароль менеджера схемы
*cn=Manager,cn=config*. Пользователь *rootdn* имеет права на чтение и
запись для всего содержимого. Кроме того, добавим минимальные
настройки для *monitor* и настроим базу *hdb*. Используем
"оффлайновую" утилиту *slapadd* для создания минимума конфигурационных
настроек, позволяющих запустить сервер.

#+caption: Преобразование схем в *ldif* формат и задание начальной конфигурации
#+begin_src sh :exports code :noweb yes
<<schema2ldif>>
#+end_src
#+caption: *slapd.ldif*: формирование корневой записи DIT и контейнера для наборов схем данных; конфигурирование базы данных *hdb* и подключение мониторинга баз данных
#+name: slapd-ldif
#+INCLUDE: ../schema/slapd.ldif src ldif

#+name: run-slapd-start6
#+begin_src sh :exports none
    service slapd start
#+end_src
#+name: run-slapd-conf6
#+begin_src sh :exports none
    cp /root/slapd.conf.obsolete /etc/openldap/slapd.conf
    ROOT_PWD=$(slappasswd -s $LDAP_ROOT_PASSWORD)
    # Use bash variable substitution to escape special chars http://stackoverflow.com/a/14339705
    sed -i "s+%LDAP_ROOT_PASSWORD%+${ROOT_PWD//+/\\+}+" /etc/openldap/slapd.conf
    chown ldap. /etc/openldap/slapd.conf
    rm -rf /etc/openldap/slapd.d

    diff /usr/share/openldap-servers/slapd.conf.obsolete /etc/openldap/slapd.conf > /gen/slapd.obsolete.diff || true
#+end_src

После перезапуска, для *5/2.3*
#+begin_src sh :exports code :noweb yes
<<run-slapd-start5>>
#+end_src
и для *6/2.4*
#+begin_src sh :exports code :noweb yes
<<run-slapd-start6>>
#+end_src
получаем сервисы, отличающиеся только настройками схемы, содержащимися
в исходных кодах разных версий *OpenLDAP*.  Например, для конфигурации
*5/2.3* требуется добавить настройки *frontend* базы, а для *6/2.4*
эти настройки добавляются автоматически из исходного кода *OpenLDAP*
(что, кстати говоря, несколько нарушает прозрачность - появляется то,
что явно не указано в *slapd.ldif* файле). Вероятно, это потому, что версия
*2.4* официально поддерживает конфигурирование с помощью *slapadd* и
*ldif* формат. Для версии *2.3* официально поддерживаемым является
способ конфигурирования через *conf* файл. Все дальнейшие изменения
уже осуществляются с помощью "онлайновых" утилит *ldapadd* и
*ldapmodify*.

#+name: add-front5
#+begin_src sh :exports none
    sleep 2

    ldapadd -v -D cn=Manager,cn=config -f /root/front.ldif -x -w $LDAP_ROOT_PASSWORD || true
#+end_src

#+caption: Добавление *frontend* для *5/2.3*
#+begin_src sh :exports code :noweb yes
<<add-front5>>
#+end_src

Специальная база данных *frontend* содержит настройки, которые применяются глобально ко всем остальным базам данных. В нашем случае это база *hdb*.

#+caption: *front.ldif*: добавление служебной базы данных *frontend* (только для *5/2.3*)
#+name: front-ldif
#+INCLUDE: ../schema/front.ldif src ldif

#+name: run-postfix
#+begin_src sh :exports none
    kill -INT `cat /var/run/openldap/slapd.pid` || true
    sleep 2

    mkdir /data/lib /data/etc
    cp -ar /var/lib/ldap /data/lib
    cp -ar /etc/openldap /data/etc
fi

rm -rf /var/lib/ldap && ln -s /data/lib/ldap /var/lib/ldap
rm -rf /etc/openldap && ln -s /data/etc/openldap /etc/openldap

exec /usr/sbin/slapd -h "ldap:/// ldaps:/// ldapi:///" -u ldap -d $DEBUG_LEVEL
#+end_src

# #+begin_note
# Первичный доступ к схемам LDAP, использующим только *ldif* формат
# (без *conf*-файлов), осуществляется при помощи *ldapi* интерфейса.  В
# случае *5/2.3* при использовании *-Y EXTERNAL -H ldapi:///* флагов по
# мере отладки появляются ошибки *Can't contact LDAP server (-1)*,
# *Insufficient access (50)* и *<olcRootPW> can only be set when rootdn
# is under suffix*. Последнюю пока разрешить не удается, поэтому
# используется явное задание пароля для rootdn (*cn=Manager,cn=config*)
# в *conf*-файле и последующее его изменение через *ldapmodify*,
# имитируя использование *ldapi*.
# #+end_note

#+begin_src sh :tangle ~/git/cc/cc-ldap-centos/ldap-server/run5.sh :comments noweb :shebang "#!/bin/bash" :exports none :noweb yes
<<run-prefix>>
<<run-db-config5>>
<<schema-prepare5>>
<<run-slapd-conf5>>
<<run-slapd-start5>>
<<run-slapd-d>>
<<schema2ldif>>
<<run-slapd-start5>>
<<add-front5>>
<<run-postfix>>
#+end_src

#+begin_src sh :tangle ~/git/cc/cc-ldap-centos/ldap-server/run6.sh :comments noweb :shebang "#!/bin/bash" :exports none :noweb yes
<<run-prefix>>
<<run-db-config6>>
<<schema-prepare6>>
<<run-slapd-conf6>>
<<run-slapd-start6>>
<<run-slapd-d>>
<<schema2ldif>>
<<run-slapd-start6>>
<<run-postfix>>
#+end_src

Дальнейшая настройка схемы осуществляется в разделе [[#schema][Схема БД LDAP]].
* Настройка аутентификации пользователей при помощи LDAP
:PROPERTIES:
:CUSTOM_ID: authentification
:ID:       49b5e2df-0c06-445a-ae9e-66bcd6cc9e40
:END:

#+begin_quote
Необходимо разработать документацию по настройке аутентификации пользователей при помощи LDAP в ОС *CentOS 5*. Проверить работоспособность выработанных инструкций в ОС *CentOS 6*.

В документацию должно входить:

- Список пакетов, которые необходимо установить;
- Список файлов, модификация которых необходима для настройки процесса аутентификации посредством LDAP;
- Описание всех опций, выставляемых в этих файлах.
#+end_quote

** Требуемые пакеты
:PROPERTIES:
:CUSTOM_ID: client-packages
:ID:       a4da4894-117b-40b6-a6c7-1447f083d6e1
:END:

Для настройки клиентского подключения в *5/2.3* понадобятся следующие пакеты

#+caption: Установка клиента для *5/2.3*
#+begin_src sh :exports code
yum install -y openssh-server openldap-clients nss_ldap authconfig
yum install -y openldap openldap-servers sudo
#+end_src

Здесь также необходим пакет *openldap-servers*, поскольку утилиты для миграции пользователей содержатся в нем. Для *6/2.4* выполним

#+caption: Установка клиента для *6/2.4*
#+begin_src sh :exports code
yum install -y openssh-server openldap-clients nss-pam-ldapd authconfig
yum install -y openldap migrationtools sudo
#+end_src

#+name: client5-run-prefix
#+begin_src sh :exports none

cp -R /etc /gen/etc5/etc

opts="-N -x group -x shadow -x gshadow -x system-auth-ac -x passwd"

#+end_src

#+name: client6-run-prefix
#+begin_src sh :exports none

cp -R /etc /gen/etc6/etc

opts="-N -x fingerprint-auth-ac -x password-auth-ac \
-x smartcard-auth-ac -x system-auth-ac -x S12nslcd -x K88nslcd"

#+end_src

#+name: client5-run-setup
#+begin_src sh :exports none
authconfig --enableshadow --enablemkhomedir --enableldap --enableldapauth \
	   --ldapserver=$LDAP_SERVER --ldapbasedn=$LDAP_BASEDN --update
#+end_src

#+name: client6-run-setup
#+begin_src sh :exports none
authconfig --enablemkhomedir --enableldap --enableldapauth \
	   --ldapserver=$LDAP_SERVER --ldapbasedn=$LDAP_BASEDN --update
#+end_src

#+name: client5-run-sudoers
#+begin_src sh :exports none

echo sudoers_base dc=mercury,dc=febras,dc=net >> /etc/ldap.conf
echo sudoers_debug 0 >> /etc/ldap.conf
echo binddn cn=authenticator,dc=mercury,dc=febras,dc=net >> /etc/ldap.conf
echo bindpw secret >> /etc/ldap.conf

#+end_src

#+name: client6-run-sudoers
#+begin_src sh :exports none

echo sudoers:  files ldap >> /etc/nsswitch.conf

echo uri ldap://$LDAP_SERVER/ >> /etc/sudo-ldap.conf
echo base dc=mercury,dc=febras,dc=net >> /etc/sudo-ldap.conf
echo sudoers_base dc=mercury,dc=febras,dc=net >> /etc/sudo-ldap.conf
echo sudoers_debug 0 >> /etc/sudo-ldap.conf
echo binddn cn=authenticator,dc=mercury,dc=febras,dc=net >> /etc/sudo-ldap.conf
echo bindpw secret >> /etc/sudo-ldap.conf

echo binddn cn=authenticator,dc=mercury,dc=febras,dc=net >> /etc/pam_ldap.conf
echo bindpw secret >> /etc/pam_ldap.conf

echo binddn cn=authenticator,dc=mercury,dc=febras,dc=net >> /etc/nslcd.conf
echo bindpw secret >> /etc/nslcd.conf

/etc/init.d/nslcd stop
rm /var/run/nslcd/*
/etc/init.d/nslcd start

#+end_src

#+name: client5-run-postfix
#+begin_src sh :exports none

cp -R /etc /gen/etc5/etcnew

diff -r $opts /gen/etc5/etc /gen/etc5/etcnew > /gen/client5.diff || true
sed -i 's|.*etcnew|/etc|g' /gen/client5.diff
diff -q -r /gen/etc5/etc /gen/etc5/etcnew | awk -F"etcnew" '{print "/etc"$2}' | sed 's/ differ//g' | sed 's|: |/|g' > /gen/client5-files.diff || true

rm -rf /gen/etc5/etc
rm -rf /gen/etc5/etcnew

getent passwd username

/usr/share/openldap/migration/migrate_passwd.pl /etc/passwd > /gen/passwd.ldif

/usr/share/openldap/migration/migrate_group.pl /etc/group > /gen/group.ldif

/usr/sbin/sshd -D
#+end_src

#+name: client6-run-postfix
#+begin_src sh :exports none

cp -R /etc /gen/etc6/etcnew

diff -r $opts /gen/etc6/etc /gen/etc6/etcnew > /gen/client6.diff || true
sed -i 's|.*etcnew|/etc|g' /gen/client6.diff
diff -q -r /gen/etc6/etc /gen/etc6/etcnew | grep -v "K88nslcd" | grep -v "S12nslcd" | awk -F"etcnew" '{print "/etc"$2}' | sed 's/ differ//g' | sed 's|: |/|g' > /gen/client6-files.diff || true

rm -rf /gen/etc6/etc
rm -rf /gen/etc6/etcnew

getent passwd username

# do not need migrate centos 6 users
# /usr/share/migrationtools/migrate_passwd.pl /etc/passwd > /gen/passwd6.ldif
# /usr/share/migrationtools/migrate_group.pl /etc/group > /gen/group6.ldif
/usr/sbin/sshd -D
#+end_src


#+begin_src sh :tangle ~/git/cc/cc-ldap-centos/ldap-client/run5.sh :comments noweb :shebang "#!/bin/bash" :exports none :noweb yes
<<client5-run-prefix>>
<<client5-run-setup>>
<<client5-run-sudoers>>
<<client5-run-postfix>>
#+end_src

#+begin_src sh :tangle ~/git/cc/cc-ldap-centos/ldap-client/run6.sh :comments noweb :shebang "#!/bin/bash" :exports none :noweb yes
<<client6-run-prefix>>
<<client6-run-setup>>
<<client6-run-sudoers>>
<<client6-run-postfix>>
#+end_src

** Используемые команды
:PROPERTIES:
:CUSTOM_ID: client-commands
:ID:       6e7a8278-7334-46f7-b289-07da7f2b6d14
:END:

Модифицируем с помощью *authconfig* и *echo*-команд конфигурацию
клиента, отдельно настроим */etc/ldap.conf*. Для *5/2.3*

#+caption: Настройка клиента для *5/2.3*
#+begin_src sh :exports code :noweb yes
<<client5-run-setup>>
<<client5-run-sudoers>>
#+end_src
и для *6/2.4* (здесь дополнительно модифицируются файлы
*nsswitch.conf*, *sudo-ldap.conf*, *nslcd.conf* и *pam_ldap.conf*)
#+caption: Настройка клиента для *6/2.4*
#+begin_src sh :exports code :noweb yes
<<client6-run-setup>>
<<client6-run-sudoers>>
#+end_src

** Изменяемые файлы
:PROPERTIES:
:CUSTOM_ID: client-files
:ID:       386e40de-d1f2-4dc8-994b-5870d4ec42fb
:END:

Файлы, которые были модифицированы [[#client-commands][настройками]] в случае *5/2.3*

#+begin_html
<div align="right">
<a onclick="toggleDiv2('myContent-client5-files',$(this));" class="fa fa-caret-down">client5-files.diff</a>
</div>
#+end_html
#+HTML: <div id="myContent-client5-files" style="display:true">
#+caption: Список измененных файлов для *5/2.3*
#+INCLUDE: /home/eab/git/cc/cc-ldap-centos/gen/client5-files.diff src diff
#+HTML: </div>

и в случае *6/2.4*

#+begin_html
<div align="right">
<a onclick="toggleDiv2('myContent-client6-files',$(this));" class="fa fa-caret-down">client6-files.diff</a>
</div>
#+end_html
#+HTML: <div id="myContent-client6-files" style="display:true">
#+caption: Список измененных файлов для *6/2.4*
#+INCLUDE: /home/eab/git/cc/cc-ldap-centos/gen/client6-files.diff src diff
#+HTML: </div>

** Описание опций
:PROPERTIES:
:CUSTOM_ID: client-options
:ID:       a8dfad56-906c-45b6-9ef1-7d5a9cfa854f
:END:

#+begin_html
<a onclick="toggleDiv2('myContent-client5',$(this));" class="fa fa-caret-right">client5.diff</a>
#+end_html

#+HTML: <div id="myContent-client5" style="display:none">
#+INCLUDE: /home/eab/git/cc/cc-ldap-centos/gen/client5.diff src diff :exports (when (eq org-export-current-backend 'odt) "none")
#+HTML: </div>

#+begin_html
<br/><a onclick="toggleDiv2('myContent-client6',$(this));" class="fa fa-caret-right">client6.diff</a>
#+end_html

#+HTML: <div id="myContent-client6" style="display:none">
#+INCLUDE: /home/eab/git/cc/cc-ldap-centos/gen/client6.diff src diff :exports (when (eq org-export-current-backend 'odt) "none")
#+HTML: </div>

* Схема БД LDAP{{{fa(star-half-o)}}}
:PROPERTIES:
:CUSTOM_ID: schema
:ID:       b64d7c36-b2b3-49ac-9620-d7c94eb9ea31
:END:
#+begin_quote
Необходимо разработать схему БД LDAP, предназначенную для хранения учетных данных пользователей кластера.
#+end_quote

Использование только *ldif* формата позволяет единообразно
конфигурировать схему *LDAP*, начиная с корневой записи DIT (Directory
Information Tree) *cn=config* и заканчивая листями этого дерева -
записями, содержащими нужную информацию:
#+begin_src sh :exports results :results raw
grep -i -h -e  "^#+caption.*\\.ldif" index.org | sed "s/#+caption://g" | sed "s/:/|/g" | sed "s/^/|/"
#+end_src

#+RESULTS:
| *slapd.ldif*  | формирование корневой записи DIT и контейнера для наборов схем данных; конфигурирование базы данных *hdb* и подключение мониторинга баз данных |
| *front.ldif*  | добавление служебной базы данных *frontend* (только для *5/2.3*)                                                                               |
| *domain.ldif* | установка суффикса, менеджера и ACL для *hdb*                                                                                                  |
| *base.ldif*   | настройка корневого суффикса, менеджера и организационных единиц                                                                               |
| *sudo.ldif*   | настройка организационной единицы *sudoers*                                                                                                    |
| *user.ldif*   | создание нового пользователя                                                                                                                   |

Если же используется *conf* формат, то надо иметь в виду, что
просто стартовая часть этого стройного ряда
конфигурационных файлов заменяется на *slapd.conf*.

** Возможности LDAP{{{fa(star)}}}
:PROPERTIES:
:CUSTOM_ID: ldap-possibilities
:ID:       4f9ddacc-3908-4cd1-b091-3f00c31aa8a7
:END:

Возможности протокола LDAP значительно определяются схемами, которые можно подключить с помощью директивы *include*. Помня об основной цели, рассмотрим типичные задачи, которые можно решить с их помощью. В первую очередь нас интересуют уже готовые схемы, входящие в дистрибутив *OpenLDAP* или разработанные сторонними поставщиками.

- [[http://pro-ldap.ru/books/openldap-ubuntu-in-practice/index.html][OpenLDAP и Ubuntu на практике]]
  - Управление пользователями и группами в *OpenLDAP*
  - Настройка аутентификации пользователей через *OpenLDAP* на клиенте
  - Настройка *OpenLDAP* в качестве хранилища правил *sudo* (sudo.schema)
  - *OpenLDAP* как хранилище карт автоматического монтирования для *autofs* (autofs.schema)
  - Репозиторий *NFS netgroup* на основе *OpenLDAP* для *autofs* (расширение возможностей стандартной схемы nis.schema)

- [[https://www.fusiondirectory.org/user_management/][FusionDirectory]]
  - Управление пользователями
    - Управление квотами пользователей
    - Управление *ssh* ключами, сертификатами пользователей
    - Управление учетными записями сервисов почты, *Samba*, *Nagios*,
      *Squid* и т.д.
  - Управление системами
    - Тонкие клиенты, десктопы, серверы, voip, сетевые и мобильные
      устройства
  - Управление сервисами
    - Управление сервисами *DHCP*, *DNS*, *Web management interface*
    - Управление репозиториями

** Подготовка к тестированию аутентификации при помощи LDAP
:PROPERTIES:
:CUSTOM_ID: minimal-schema
:ID:       3446a07c-3649-4e85-84c1-044e78c340dc
:END:

Чтобы получить минимально работоспособный сервер LDAP, позволяющий
осуществлять аутентификацию для клиентских систем, внесем необходимые
изменения в схему. В частности, [[domain-ldif][сконфигурируем]] базу *hdb* для
доменного имени *dc=mercury,dc=febras,dc=net*, определим менеджера
домена *cn=Manager,dc=mercury,dc=febras,dc=net* и его пароль.  Также,
добавим в *domain.ldif* правила доступа к атрибутам *userPassword* и
*shadowLastChange*: для менеджера домена и владельца записи -- write и
для неавторизованного пользователя -- auth.

Далее, [[base-ldif][пропишем]] необходимые атрибуты, начиная с корневого узла *dn:
dc=mercury,dc=febras,dc=net*, добавим подразделения *people*, *groups*
и *sudoers*. Создадим одну posix-группу *wheel* и сконфигурируем
*sudoers* так, чтобы разрешить выполнение *sudo* команд без ввода
пароля для членов этой группы.

#+name: build-schema
#+begin_src sh :exports none

cd /schema

cp domain.ldif domain+.ldif
MANAGER_PWD=$(slappasswd -s $LDAP_MANAGER_PASSWORD)
# Use bash variable substitution to escape special chars http://stackoverflow.com/a/14339705
sed -i "s+%LDAP_MANAGER_PASSWORD%+${MANAGER_PWD//+/\\+}+" domain+.ldif
ldapmodify -v -D cn=Manager,cn=config -f domain+.ldif -x -w $LDAP_ROOT_PASSWORD
rm domain+.ldif
ldapadd -x -D 'cn=Manager,dc=mercury,dc=febras,dc=net' -w $LDAP_MANAGER_PASSWORD -f base.ldif
ldapadd -x -D 'cn=Manager,dc=mercury,dc=febras,dc=net' -w $LDAP_MANAGER_PASSWORD -f sudo.ldif
#+end_src
#+begin_src sh :exports code :noweb yes
<<build-schema>>
#+end_src

#+begin_src sh :tangle ~/git/cc/cc-ldap-centos/schema/build.sh :comments noweb :shebang "#!/bin/bash" :exports none :noweb yes
<<build-schema>>
<<add-user>>
#+end_src

#+caption: *domain.ldif*: установка суффикса, менеджера и ACL для *hdb*
#+name: domain-ldif
#+INCLUDE: ../schema/domain.ldif src ldif

#+caption: *base.ldif*: настройка корневого суффикса, менеджера и организационных единиц
#+INCLUDE: /home/eab/git/cc/cc-ldap-centos/schema/base.ldif src ldif

#+caption: *sudo.ldif*: настройка организационной единицы *sudoers*
#+INCLUDE: /home/eab/git/cc/cc-ldap-centos/schema/sudo.ldif src ldif

* Процесс добавления нового пользователя в систему{{{fa(star-half-o)}}}
:PROPERTIES:
:CUSTOM_ID: new-user
:ID:       6fe3c37d-639a-4656-9675-bdc7a6c5ddb2
:END:

#+begin_quote
Необходимо разработать документацию по процессу добавления нового
пользователя в систему, использующего аутентификацию посредством
LDAP. Предложить CLI (или GUI WEB) интерфейс для выполнения данной
операции. Ориентироваться на использование в ОС *CentOS 5/6*.
#+end_quote

** Добавление пользователя с помощью CLI интерфейса
:PROPERTIES:
:CUSTOM_ID: new-user-ldap
:ID:       6e8437bc-7e1f-489a-9afb-44f3d67d49ab
:END:

Используем утилиту *ldapadd* для добавления записи пользователя в формате *ldif*

#+name: add-user
#+begin_src sh :exports none
ldapadd -x -D 'cn=Manager,dc=mercury,dc=febras,dc=net' -w $LDAP_MANAGER_PASSWORD -f user.ldif

#+end_src
#+begin_src sh :exports code :noweb yes
<<add-user>>
#+end_src

#+caption: *user.ldif*: создание нового пользователя
#+INCLUDE: "../schema/user.ldif" src ldif

** Добавление пользователя с помощью GUI Web интерфейса{{{fa(star)}}}
:PROPERTIES:
:CUSTOM_ID: new-user-php
:ID:       6de9e6dc-04f2-429d-b22e-55caa2e270ee
:END:

Как мы видели, добавление записи в БД LDAP с помощью *ldif*-файла
сопровождается некоторым дублированием информации и мелкими
неудобствами. Например, приходится дублировать часть уникального имени
*dn*, хотя при использовании более развитых средств, эта часть могла
быть получена из контекста автоматически. С другой стороны, такая
форма записи "говорит сама за себя": уникальное имя полностью
определяет место объекта в БД, являясь одновременно как описательной
(по аналогии с *SQL Data Definition Language*) - при использовании
*ldapsearch*, так и модфицирующей (*SQL Data Manipulation Language*)
конструкцией - в случае использования утилит *ldapadd/slapadd* или
*ldapmodify/slapmodify*.

Далее, приходится дублировать одинаковые для всех записей пользователя
поля *objectClass*, но с этим вполне можно смириться, поскольку обычно
используется готовый шаблон *ldif*-файла и уже в него вносятся
изменения. Чуть большее неудобство таит в себе поле *gidNumber*,
поскольку приходится узнавать и прописывать номер группы. Впрочем, при
небольшом количестве групп, а тем более при наличии одной группы, это
не является проблемой.

В случае гибкой работы с настройками *shadow* полей, такой текстовый
интерфейс начнет приносить ощутимые проблемы, т.к., например, для
полей *shadowLastChange* и *shadowMax* необходимо вычислять количество
дней - а это уже явно требует автоматизации.

Поле *userPassword* также требует аккуратного обращения: необходимо
каким то образом применять шифрование пароля с помощью утилит
*ldappasswd* или *slappasswd*.

Эти и другие проблемы призван решить GUI интерфейс, который позволяет
с помощью доступных шаблонов и средств описания GUI, реализовывать
нужную функциональность, в некоторых случаях значительно облегчая
работу со схемой БД LDAP.
#+begin_html
<div align="right">
<a onclick="toggleDiv2('shadow',$(this));" class="fa fa-caret-right">custom-ShadowAccount.xml</a>
</div>
#+end_html
#+HTML: <div id="shadow" style="display:none">
#+caption: xml-файл шаблона *User Account With Shadow* браузера схемы
#+INCLUDE: /home/eab/git/cc/cc-ldap-centos/misc/custom-ShadowAccount.xml src xml :exports (when (eq org-export-current-backend 'odt) "none")
#+HTML: </div>

#+NAME:   fig:php01
#+caption: Создание пользователя с использованием шаблона phpLDAPadmin
[[./php01.png]]

** Тестирование клиентского подключения
:PROPERTIES:
:CUSTOM_ID: test-client
:ID:       061371a3-a5d6-4fa2-9e15-2d8adef5caf0
:END:

Для проверки возможности аутентификации будем использовать [[#new-user-ldap][запись]] *username*. Протестируем подключение с помощью команды
#+begin_src sh
getent passwd username
#+end_src
которая выводит passwd данные пользователя *username* из доступных источников, в данном случае задействован сервер LDAP
#+begin_src conf-colon
username:x:1050:1030:User Name:/home/webminder:/bin/bash
#+end_src

Убедимся, что механизм *sudoers* задействован. Вывод команды
#+begin_src sh
sshpass -p p@ssw0rd ssh -t username@$(ip) sudo ls /root
#+end_src
демонстрирует, что пользователь *username* успешно прочитал содержимое каталога *root* с помощью *sudo*
#+begin_src raw
Dockerfile5  Dockerfile6  run5.sh  run6.sh
#+end_src

** Стандартные команды администрирования пользователей в случае использования LDAP{{{fa(star)}}}
:PROPERTIES:
:CUSTOM_ID: standard-commands
:ID:       84d40fcf-c285-40e6-9f13-11685889a085
:END:
#+begin_quote
Предложить LDAP-варианты для команд *passwd*, *useradd*, *usermod*, *finger*, *chsh*, *chfn* и функциональности *.forward*.
#+end_quote

#+caption: Изменение пароля пользователя с помощью утилиты *ldappasswd*
#+begin_src sh
ldappasswd -h $(ip) -x -D "uid=username,ou=people,dc=mercury,dc=febras,dc=net" -w p@ssw0rd -s 1
#+end_src

#+caption: Изменение значения *loginShell* с помощью утилиты *ldapmodify*
#+name: modify-sh
#+INCLUDE: ../schema/modify.sh src sh

** Миграция пользователей и групп
:PROPERTIES:
:CUSTOM_ID: add-users
:ID:       3c998117-af2e-4965-94c7-3ebfb31d7691
:END:

#+begin_html
<a onclick="toggleDiv2('myContent-passwd',$(this));" class="fa fa-caret-right">passwd.ldif</a>
#+end_html

#+HTML: <div id="myContent-passwd" style="display:none">
#+INCLUDE: /home/eab/git/cc/cc-ldap-centos/gen/passwd.ldif src ldif :exports (when (eq org-export-current-backend 'odt) "none")
#+HTML: </div>

# do not need migrate centos 6 users
# #+begin_html
# <br/><a onclick="toggleDiv2('myContent-passwd6',$(this));" class="fa fa-caret-right">passwd6.ldif</a>
# #+end_html

# #+HTML: <div id="myContent-passwd6" style="display:none">
# #+INCLUDE: /home/eab/git/cc/cc-ldap-centos/gen/passwd6.ldif src ldif :exports (when (eq org-export-current-backend 'odt) "none")
# #+HTML: </div>

#+begin_html
<br/><a onclick="toggleDiv2('myContent-group',$(this));" class="fa fa-caret-right">group.ldif</a>
#+end_html

#+HTML: <div id="myContent-group" style="display:none">
#+INCLUDE: /home/eab/git/cc/cc-ldap-centos/gen/group.ldif src ldif :exports (when (eq org-export-current-backend 'odt) "none")
#+HTML: </div>

# do not need migrate centos 6 users
# #+begin_html
# <br/><a onclick="toggleDiv2('myContent-group6',$(this));" class="fa fa-caret-right">group6.ldif</a>
# #+end_html

# #+HTML: <div id="myContent-group6" style="display:none">
# #+INCLUDE: /home/eab/git/cc/cc-ldap-centos/gen/group6.ldif src ldif :exports (when (eq org-export-current-backend 'odt) "none")
# #+HTML: </div>

* Перевести аутентификацию пользователей кластера на использование LDAP
:PROPERTIES:
:CUSTOM_ID: cluster
:ID:       db5bc4cf-74c3-40e0-b8b3-d57f3f32e338
:END:

